os:
    - osx
    - linux

# https://docs.travis-ci.com/user/reference/osx/#OS-X-Version
# Default: 9.4
osx_image: xcode11.3  # macOS 10.14

# Linux Ubuntu Precise
sudo: required
dist: trusty
group: travis_latest

language: node_js
node_js:
    - '10'

cache:
    directories:
        - $HOME/.electron

addons:
    apt:
        packages:
            - icnsutils
            - graphicsmagick
            - gcc-multilib
            - g++-multilib

before_install:
    - git --version
    - git config --global user.name "Travis CI"
    - git config --global user.email "travis@travis-ci.org"
    - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
        brew update;
        fi
    - npm install -g npm
    - npm --version

install: travis_wait 40 npm install

script:
    - npm run build

after_success:
    - npm run coveralls
    - mkdir -p releases
    - PRODUCT_NAME='Snapmaker Luban'
    - PACKAGE_NAME=`node -e "console.log(require('./src/package.json').name)"`
    - PACKAGE_VERSION=`node -e "console.log(require('./src/package.json').version)"`
    - RELEASE=${PACKAGE_NAME}-${PACKAGE_VERSION}
    - COMMIT_LOG=`git log -1 --format='%ci %H %s'`
    - |
        # build:mac-x64
        if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
            # https://github.com/electron-userland/electron-osx-sign/issues/83
            # Temporarily Bypass Gatekeeper
            sudo spctl --master-disable;
            sudo spctl --status;
            travis_wait 30 npm run build:mac-x64;
            ls -al output output/*;
            cp -af "output/${PRODUCT_NAME}-${PACKAGE_VERSION}.dmg" "releases/${RELEASE}-mac-x64.dmg";
            ls -al releases/*;
        fi
    - |
        # build:linux-x64
        if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
            npm run build:linux-x64;
            ls -al output output/*;
            cp -af "output/${PACKAGE_NAME}_${PACKAGE_VERSION}_amd64.deb" "releases/${RELEASE}-linux-amd64.deb";
            pushd releases;
            ln -sf ../output/linux-unpacked "${RELEASE}-linux-x64";
            tar zcfh "${RELEASE}-linux-x64.tar.gz" "${RELEASE}-linux-x64";
            rm -f "${RELEASE}-linux-x64";
            popd;
            ls -al releases/*;
        fi
    - |
        # build:linux-ia32
        if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
            npm run build:linux-ia32;
            ls -al output output/*;
            cp -af "output/${PACKAGE_NAME}_${PACKAGE_VERSION}_i386.deb" "releases/${RELEASE}-linux-i386.deb";
            pushd releases;
            ln -sf ../output/linux-ia32-unpacked "${RELEASE}-linux-ia32";
            tar zcfh "${RELEASE}-linux-ia32.tar.gz" "${RELEASE}-linux-ia32";
            rm -f "${RELEASE}-linux-ia32";
            popd;
            ls -al releases/*;
        fi

before_deploy:
    - echo "Deploying to GitHub releases"

deploy:
    provider: releases
    api_key:
        secure: yzRhwVd3S04FHhkwoGlAnqtME5E4c3EKStnTigI52DQBXD6UU76FmIrLnCrkfi5G8q1i+qlWpOwm8pLBt24QV/FXFiWgIKXKS50xp/1vItCwXQxpOiPJnBixLTIaUTGsilh6WfA/+iP3eBX+4FkM/SkcnpBDq6xk4xfmoTBJ1Roe/Gj4c8AWner7vd5hdERCRPZSB+3ITMlOVMQ+vpbuyuDxnK8xsBnqtdvgJERyA4O+4fHgxlxp+5znRu78n740EX3VqPLJhn9oM7CVbf/ogKZ+ZaMVov8Is1a3yXN6BTjHb2Ar5i+DT0/TBiTuUy7wG2JnNOG/7EGDUJYl6mJNBBbIIrBD+KdfnpRgziSYNL17wGj1u2PNjviuXjdrjyG+wlSZeeXDoo+T76Z0v7mcDlgrFNWqaoNHQcegh4zRQ7JplKSnc1Ok0llmfXub5xT+v4IDuMJJ4XlZhdc5BurzkWNWCHXT3r8LUCySbW7tef0+sOpcqhzKLOOOnYaDUZV+FYzxzqmZEzbM2Envq98/umWyaDBsDik8K8ZYgxuoMo4PRDV5cpXhCoC7p0WzmPLjRqSJH+KNUtkiFh7GGXQrq06HrP31M/C04UxzVDTGOshg6GAbTCEMsX3BDtmKZVkl+LxW9R8u/f1Wk/3hIOcU0ZUeg0LkZTWd3mOz+YKa/ME=
    file_glob: true
    file:
        - 'releases/*.*'
    overwrite: true
    skip_cleanup: true
    on:
        # https://docs.travis-ci.com/user/deployment#Conditional-Releases-with-on
        tags: true  # Deploy app only when a tag is applied to the commit
        node: '10'
        repo: parachvte/Luban
